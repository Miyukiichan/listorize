@page "/"
@page "/list/{id:int}"
@using listorize.Components.Util
@using Microsoft.EntityFrameworkCore
@using Model
@inject NavigationManager navManager
@inject IDialogService dialogs
@inject ListorizeContext db
@inject ISnackbar snackbar

<PageTitle>@Title</PageTitle>

<h1>@Title</h1>
<br />

<Grid @ref="grid" T="Item" NavigationURI="list" OnOpen="OnOpen" GetData="GetData">
    <ChildContent>
        <PropertyColumn T="Item" TProperty="string" Property="x => x.Name"></PropertyColumn>
    </ChildContent>
    <Toolbar>
        <MudStack Row>
            <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Outlined.Add" OnClick="AddNote">Note</MudButton>
            <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Outlined.Add" OnClick="AddList">List</MudButton>
        </MudStack>
    </Toolbar>
</Grid>

<MudMessageBox @ref="NewNoteMsg" Title="New Note">
    <MessageContent>
        <MudTextField @bind-Value="NewNoteName" Label="Name" Required="true"></MudTextField>
    </MessageContent>
</MudMessageBox>

<MudMessageBox @ref="NewListMsg" Title="New List">
    <MessageContent>
        <MudTextField @bind-Value="NewListName" Label="Name" Required="true"></MudTextField>
    </MessageContent>
</MudMessageBox>

@code {
    [Parameter] public int? Id { get; set; }
    string NewNoteName = "";
    MudMessageBox? NewNoteMsg;
    string NewListName = "";
    MudMessageBox? NewListMsg;
    Grid<Item>? grid;
    Item? Item;
    string Title = "Home";
    protected override async Task OnInitializedAsync() {
        if (Id is not null) {
            Item = db.Items.FirstOrDefault(x => x.Id == Id);
            if (Item is not null) {
                Title = $"List - {Item.Name}";
            }
        }
        await base.OnInitializedAsync();
    }
    async Task OnOpen(Item item) {
        if (item.NoteId is not null) {
            navManager.NavigateTo($"/note/{item.Id}");
        }
        else {
            navManager.NavigateTo($"/list/{item.Id}", true);
        }
    }
    async Task<List<Item>> GetData() {
        return db.Items
            .Include(x => x.Note)
            .Where(x => x.ParentItemId == Id)
            .ToList();
    }
    async Task AddNote() {
        NewNoteName = "";
        if (NewNoteMsg is null) return;
        await NewNoteMsg.ShowAsync();
        if (string.IsNullOrWhiteSpace(NewNoteName)) {
            snackbar.Add("Cancelled note creation");
            return;
        }
        var note = new Note {
            Body = "",
        };
        var item = new Item {
            Name = NewNoteName,
            ParentItemId = Id,
            Note = note,
        };
        db.Items.Add(item);
        var changes = db.SaveChanges();
        if (changes < 1) {
            await dialogs.ShowMessageBox("Error", "Failed to create note");
        }
        else {
            snackbar.Add("Note created", Severity.Success);
        }
        await OnOpen(item);
    }
    async Task AddList() {
        NewListName = "";
        if (NewListMsg is null) return;
        await NewListMsg.ShowAsync();
        if (string.IsNullOrWhiteSpace(NewListName)) {
            snackbar.Add("Cancelled list creation");
            return;
        }
        var item = new Item {
            Name = NewListName,
            ParentItemId = Id,
        };
        db.Items.Add(item);
        var changes = db.SaveChanges();
        if (changes < 1) {
            await dialogs.ShowMessageBox("Error", "Failed to create list");
        }
        else {
            snackbar.Add("List created", Severity.Success);
        }
        await OnOpen(item);
    }
}
